blueprint:
  name: TRV06 – Dynamic Setpoint Heizlogik V3 (External Sensor, HEAT/HOLD/COOL)
  description: >
    Vollautomatische Heizlogik für Tuya/AVATTO TRV06.
    Nutzt externen Temperatursensor zur präzisen Regelung und verhindert
    Überhitzen durch automatische COOL-Logik.
    Hält den Heizkörper warm (HOLD) und verhindert kalte Stellen.
    Inklusive Fenster-Logik, Tag/Nacht, Overshoot-Margin und Master-Schalter.

  domain: automation

  input:

    climate:
      name: Thermostat
      selector: { entity: { domain: climate } }

    room_temp_sensor:
      name: Raumtemperatur (extern)
      selector: { entity: { domain: sensor } }

    trv_internal_temp:
      name: TRV interne Temperatur
      selector: { entity: { domain: sensor } }

    window_sensor:
      name: Fenster-/Türsensor
      selector: { entity: { domain: binary_sensor } }

    heating_enabled:
      name: Heizlogik EIN/AUS (Master)
      selector: { entity: { domain: input_boolean } }

    # TAG / NACHT Zeiten wieder einstellbar
    day_time:
      name: Start TAG
      default: "08:00:00"
      selector: { time: {} }

    night_time:
      name: Start NACHT
      default: "22:00:00"
      selector: { time: {} }

    # Zieltemperaturen
    day_set_temp:
      name: TAG Zieltemperatur
      default: 23.0
      selector: { number: { min: 5, max: 30, step: 0.5 } }

    night_set_temp:
      name: NACHT Zieltemperatur
      default: 18.0
      selector: { number: { min: 5, max: 30, step: 0.5 } }

    # Heizlogik Parameter
    hold_offset:
      name: Warmhalten-Offset (HOLD)
      default: 1.0
      selector: { number: { min: 0.5, max: 5, step: 0.1 } }

    cool_offset:
      name: COOL Offset (unter TRV-Temp)
      default: -2.0
      selector: { number: { min: -5, max: 0, step: 0.1 } }

    overshoot_margin:
      name: Overshoot-Margin (°C)
      default: 0.3
      selector: { number: { min: 0.1, max: 2, step: 0.1 } }

    window_delay:
      name: Fenster-Delay (Sekunden)
      default: 60
      selector: { number: { min: 0, max: 600, step: 5 } }

    debug:
      name: Debug Logging
      default: true
      selector: { boolean: {} }

mode: restart
max_exceeded: silent

variables:

  climate_entity: !input climate
  room_temp_entity: !input room_temp_sensor
  trv_temp_entity: !input trv_internal_temp
  window_entity: !input window_sensor
  heating_sw: !input heating_enabled

  day_start: !input day_time
  night_start: !input night_time

  day_set: !input day_set_temp
  night_set: !input night_set_temp

  hold_offset: !input hold_offset
  cool_offset: !input cool_offset
  overshoot_margin: !input overshoot_margin
  window_delay_seconds: !input window_delay
  debug_log: !input debug

  nowtime: "{{ now().strftime('%H:%M:%S') }}"

  room_temp: "{{ states(room_temp_entity) | float(999) }}"
  trv_internal: "{{ states(trv_temp_entity) | float(20) }}"

  daytime: "{{ day_start <= nowtime < night_start }}"
  target_temp: "{{ (day_set if daytime else night_set) | float }}"

  hold_setpoint: "{{ (trv_internal + hold_offset) | round(1) }}"
  cool_setpoint: "{{ (trv_internal + cool_offset) | round(1) }}"

  window_open: "{{ is_state(window_entity, 'on') }}"

trigger:
  - platform: state
    entity_id:
      - !input room_temp_sensor
      - !input trv_internal_temp
      - !input window_sensor
      - !input heating_enabled

  - platform: time
    at: !input day_time

  - platform: time
    at: !input night_time

action:

  # LOG
  - choose:
      - conditions: "{{ debug_log }}"
        sequence:
          - service: logbook.log
            data:
              name: "TRV06 Heizlogik"
              message: >
                PRE: Room={{ room_temp }} TRV={{ trv_internal }}
                Target={{ target_temp }}
                HOLD={{ hold_setpoint }} COOL={{ cool_setpoint }}
                Time={{ nowtime }}

  # MASTER AUS
  - choose:
      - conditions:
          - condition: state
            entity_id: !input heating_enabled
            state: "off"
        sequence:
          - service: climate.set_temperature
            data: { temperature: 5 }
            target: { entity_id: "{{ climate_entity }}" }
          - delay: "00:00:02"
          - service: climate.turn_off
            target: { entity_id: "{{ climate_entity }}" }
          - stop: "MASTER OFF"

  # FENSTER OFFEN
  - choose:
      - conditions: "{{ window_open }}"
        sequence:
          - delay: { seconds: "{{ window_delay_seconds }}" }
          - condition: template
            value_template: "{{ window_open }}"
          - service: climate.set_temperature
            data: { temperature: 5 }
            target: { entity_id: "{{ climate_entity }}" }
          - delay: "00:00:02"
          - service: climate.turn_off
            target: { entity_id: "{{ climate_entity }}" }
          - stop: "FENSTER OFFEN"

  # HEAT / HOLD / COOL – LOGIK
  - choose:

      # 1 — HEAT (Aufheizen)
      - conditions: "{{ room_temp < target_temp }}"
        sequence:
          - service: climate.turn_on
            target: { entity_id: "{{ climate_entity }}" }
          - service: climate.set_temperature
            data: { temperature: "{{ target_temp }}" }
            target: { entity_id: "{{ climate_entity }}" }

      # 2 — HOLD (Warmhalten, wenn exakt im Zielbereich)
      - conditions: >
          {{ room_temp >= target_temp
             and room_temp < (target_temp + overshoot_margin) }}
        sequence:
          - service: climate.turn_on
            target: { entity_id: "{{ climate_entity }}" }
          - service: climate.set_temperature
            data: { temperature: "{{ hold_setpoint }}" }
            target: { entity_id: "{{ climate_entity }}" }

      # 3 — COOL (Überhitzt → runterregeln)
      - conditions: "{{ room_temp >= (target_temp + overshoot_margin) }}"
        sequence:
          - service: climate.turn_on
            target: { entity_id: "{{ climate_entity }}" }
          - service: climate.set_temperature
            data: { temperature: "{{ cool_setpoint }}" }
            target: { entity_id: "{{ climate_entity }}" }
